<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Inbox Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      background: #0b3c5d;
      color: white;
      padding: 20px;
      width: 300px;
      box-sizing: border-box;
    }
    .sidebar input {
      width: 100%;
      padding: 10px;
    }
    .email-list {
      margin-top: 20px;
      list-style-type: none;
      padding: 0;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
    }
    .email-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
    }
    .email-item:hover {
      background: #555;
    }
    .content {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .email-view {
      background-color: #fff;
      padding: 30px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>CHECK YOUR INBOX!</h2>
    <input id="userInput" type="text" placeholder="Enter inbox name">
    <button onclick="checkInbox()">Check</button>
    <ul id="emailList" class="email-list"></ul>
  </div>
  <div class="content">
    <div id="emailContent" class="email-view hidden">
      <h3></h3>
      <p><b>From:</b> <span id="emailFrom"></span></p>
      <p><b>To:</b> <span id="emailTo"></span></p>
      <p><b>Date:</b> <span id="emailDate"></span></p>
      <pre id="emailBody"></pre>
      <button onclick="backToList()">Quay lại Inbox</button>
    </div>
  </div>
  <script>
    const apiUrl = '/api/emails';

    function formatDate(dateStr) {
      return new Intl.DateTimeFormat("vi-VN", {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false,
        timeZone: "Asia/Ho_Chi_Minh"
      }).format(new Date(dateStr));
    }

    async function checkInbox() {
      const emailUser = document.getElementById("userInput").value.trim();
      if (!emailUser) { alert("Nhập tên hộp thư trước!"); return; }

      const emailList = document.getElementById("emailList");
      emailList.innerHTML = "<li>Đang tải email...</li>";

      try {
        const response = await fetch(\`\${apiUrl}?user=\${emailUser}\`);
        if (!response.ok) throw new Error('Không thể fetch API');
        const emails = await response.json();

        emailList.innerHTML = "";
        if (emails.length === 0) {
          emailList.innerHTML = "<li>Chưa có thư nào</li>";
          return;
        }

        emails.forEach(mail => {
          const dateStr = formatDate(mail.date);

          const item = document.createElement("li");
          item.className = "email-item";
          item.innerHTML = \`
            <b>from:</b> \${mail.from} <br>
            <b>subject:</b> \${mail.subject} <br>
            <b>date:</b> \${dateStr}
          \`;
          item.onclick = () => readMail(mail.id);
          emailList.appendChild(item);
        });
      } catch (error) {
        emailList.innerHTML = \`<li>Error: \${error.message}</li>\`;
        console.error(error);
      }
    }

    async function readMail(id) {
      const emailUser = document.getElementById("userInput").value.trim();
      if (!emailUser) return;

      const emailContent = document.getElementById("emailContent");
      emailContent.classList.remove("hidden");

      try {
        const response = await fetch(\`\${apiUrl}?user=\${emailUser}&id=\${id}\`);
        if (!response.ok) throw new Error('Không thể fetch email');
        const mail = await response.json();

        const dateStr = formatDate(mail.date);

        emailContent.querySelector("h3").innerText = mail.subject;
        document.getElementById("emailFrom").innerText = mail.from;
        document.getElementById("emailTo").innerText = mail.to;
        document.getElementById("emailDate").innerText = dateStr;
        document.getElementById("emailBody").innerText = mail.body || "(Email rỗng)";
      } catch (error) {
        emailContent.innerHTML = \`<p>Error: \${error.message}</p>\`;
        console.error(error);
      }
    }

    function backToList() {
      const emailContent = document.getElementById("emailContent");
      emailContent.classList.add("hidden");
    }
  </script>
</body>
</html>
